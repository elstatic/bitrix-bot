---
name: weekly-review
description: "Обзор недели: сводка по задачам, встречам, перепискам из Битрикс24 и активности в локальных проектах. Активируется при упоминании: обзор недели, weekly review, итоги недели, сводка за неделю, что было за неделю, недельный отчёт"
---

# Weekly Review Skill

Skill для формирования сводки за неделю: задачи, встречи и переписки из Битрикс24 + активность в локальных проектах через субагента `project-activity-digest`.

**Read-only** — skill только читает данные.

## Авторизация

Вебхук хранится в файле `.env` в корне проекта в переменной `BITRIX24_WEBHOOK_URL`.

Каждый curl-запрос выполняй так:

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.name.json" ...
```

Если `.env` отсутствует или переменная не задана, сообщи пользователю:
> Создайте файл `.env` в корне проекта с содержимым:
> `export BITRIX24_WEBHOOK_URL="https://your-domain.bitrix24.ru/rest/USER_ID/WEBHOOK_CODE/"`

### ВАЖНО: не пайпить curl в python/jq в одной команде

**НИКОГДА** не делай `source .env && curl ... | python3 ...` — `source` может сломать пайп, и python получит пустой stdin.

Правильный подход — вызывать curl **отдельной командой** без пайпа. Если нужна постобработка — делай в два отдельных вызова Bash, либо сохраняй результат curl в переменную:

```bash
# НЕПРАВИЛЬНО (ломается):
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.json" | python3 -c "..."

# ПРАВИЛЬНО — curl без пайпа:
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.json"
```

## Определение периода

- По умолчанию — **текущая неделя**: от понедельника текущей недели до сегодня (включительно).
- «Прошлая неделя» — понедельник–воскресенье предыдущей недели.
- Пользователь может указать конкретные даты — адаптируй фильтры.

Для вычисления границ недели используй bash:
```bash
# Текущая неделя (пн–сегодня)
WEEK_START=$(date -v-Mon -v0H -v0M -v0S +%Y-%m-%d 2>/dev/null || date -d 'last monday' +%Y-%m-%d)
WEEK_END=$(date +%Y-%m-%d)

# Прошлая неделя (пн–вс)
WEEK_START=$(date -v-Mon -v-7d +%Y-%m-%d 2>/dev/null || date -d 'last monday - 7 days' +%Y-%m-%d)
WEEK_END=$(date -v-Mon -v-1d +%Y-%m-%d 2>/dev/null || date -d 'last sunday' +%Y-%m-%d)
```

## Алгоритм сбора данных

Сначала получи профиль пользователя, затем запускай **4 параллельных потока**.

### Шаг 0: Получить профиль пользователя

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}profile.json"
```

Поле `result.ID` — ID пользователя. Поле `result.NAME` + `result.LAST_NAME` — имя для отображения.

---

### Поток 1: Задачи Битрикс24

Используй формат дат `YYYY-MM-DD` и `--data-urlencode` для фильтров с операторами.

Для фильтрации по неделе:
- `filter[>FIELD]=<ДЕНЬ_ДО_НАЧАЛА_НЕДЕЛИ>` (день перед понедельником)
- `filter[<FIELD]=<ДЕНЬ_ПОСЛЕ_КОНЦА_НЕДЕЛИ>` (день после последнего дня)

#### 1а. Задачи, которые я создал за неделю

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[CREATED_BY]=<USER_ID>' \
  --data-urlencode 'filter[>CREATED_DATE]=<ДЕНЬ_ДО>' \
  --data-urlencode 'filter[<CREATED_DATE]=<ДЕНЬ_ПОСЛЕ>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=STATUS' \
  -d 'select[]=CREATED_DATE' -d 'select[]=RESPONSIBLE_ID'
```

#### 1б. Задачи, которые мне поставили за неделю

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[RESPONSIBLE_ID]=<USER_ID>' \
  --data-urlencode 'filter[>CREATED_DATE]=<ДЕНЬ_ДО>' \
  --data-urlencode 'filter[<CREATED_DATE]=<ДЕНЬ_ПОСЛЕ>' \
  --data-urlencode 'filter[!CREATED_BY]=<USER_ID>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=STATUS' \
  -d 'select[]=CREATED_DATE' -d 'select[]=CREATED_BY'
```

#### 1в. Задачи, закрытые за неделю

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[RESPONSIBLE_ID]=<USER_ID>' \
  -d 'filter[STATUS]=5' \
  --data-urlencode 'filter[>CLOSED_DATE]=<ДЕНЬ_ДО>' \
  --data-urlencode 'filter[<CLOSED_DATE]=<ДЕНЬ_ПОСЛЕ>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=CLOSED_DATE'
```

#### 1г. Активные задачи (не закрытые, на мне)

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[RESPONSIBLE_ID]=<USER_ID>' \
  --data-urlencode 'filter[!STATUS]=5' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=STATUS' -d 'select[]=DEADLINE' \
  -d 'select[]=TIME_SPENT_IN_LOGS' \
  -d 'order[ACTIVITY_DATE]=desc' \
  -d 'start=0'
```

Возвращает до 50 задач, отсортированных по дате последней активности. Показывай статус и дедлайн (если есть).

#### 1д. Трудозатраты за неделю

Цель — показать, сколько времени пользователь залогировал за целевой период.

**Стратегия**: собрать ID задач из запросов 1а–1г (все уникальные), затем через batch-запрос получить записи трудозатрат и отфильтровать по дате.

1. Собери уникальные ID задач из всех предыдущих запросов (созданные + поставленные + закрытые + активные). Максимум 50 ID (ограничение batch).

2. Сформируй batch-запрос:

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}batch.json" \
  -H "Content-Type: application/json" \
  -d '{
    "halt": 0,
    "cmd": {
      "t_<ID1>": "task.elapseditem.getlist?TASKID=<ID1>&ORDER[CREATED_DATE]=desc",
      "t_<ID2>": "task.elapseditem.getlist?TASKID=<ID2>&ORDER[CREATED_DATE]=desc",
      ...
    }
  }'
```

3. Из ответа `result.result` для каждой задачи получи массив записей. Каждая запись содержит:
   - `CREATED_DATE` — дата записи
   - `SECONDS` — количество секунд
   - `USER_ID` — кто залогировал
   - `COMMENT_TEXT` — комментарий к записи

4. Отфильтруй записи: `CREATED_DATE` попадает в целевой период И `USER_ID` = ID текущего пользователя.

5. Посчитай сумму `SECONDS` по всем записям — это общие трудозатраты за неделю. Конвертируй в часы и минуты.

6. Сгруппируй по задачам для детализации.

**Без проверки комментариев** — за неделю слишком много API-вызовов.

---

### Поток 2: Встречи из календаря

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}calendar.event.get.json" \
  -H "Content-Type: application/json" \
  -d '{"type":"user","ownerId":<USER_ID>,"from":"<WEEK_START>","to":"<WEEK_END>"}'
```

Ключевые поля ответа:
- `ID`, `NAME` — ID и название
- `DATE_FROM` / `DATE_TO` — начало и конец
- `DESCRIPTION` — описание
- `LOCATION` — место/ссылка на звонок
- `IS_MEETING` — есть ли участники
- `MEETING_STATUS` — `Y` (принял), `N` (отклонил), `Q` (не ответил)
- `DT_SKIP_TIME` — `Y` если событие на весь день

**Фильтрация**: показывай только события со статусом `Y` или `Q`. С `N` — пропускай.

**Группировка**: группируй встречи по дням недели для вывода.

---

### Поток 3: Дайджест переписок

Вызови субагента `chat-digest` через `Task` tool. **ВАЖНО**: НЕ используй `run_in_background: true` — субагенту нужен доступ к инструментам, который недоступен в фоновом режиме.

Передай в промпте:
- `BITRIX24_WEBHOOK_URL` из `.env` (уже загружен на этапе авторизации)
- `USER_ID` и `USER_NAME` (из Шага 0)
- Период: `WEEK_START` — `WEEK_END`
- Лимит чатов: 15
- Топ диалогов для выжимки: 10

```
Task(
  subagent_type: "chat-digest",
  prompt: "Сформируй дайджест переписок Битрикс24.
    BITRIX24_WEBHOOK_URL: <URL>
    USER_ID: <ID>
    USER_NAME: <ИМЯ>
    Период: с <WEEK_START> по <WEEK_END>
    Лимит чатов: 15
    Топ диалогов: 10",
  description: "Chat digest"
)
```

Результат субагента включи в секцию «Ключевые переписки» как есть. Если субагент вернул сообщение об отсутствии переписок — секцию не показывай.

---

### Поток 4: Активность в локальных проектах

**Сначала** прочитай `PROJECTS_DIRS` из `.env`, чтобы передать папки субагенту:

```bash
source .env && echo "$PROJECTS_DIRS"
```

Если `PROJECTS_DIRS` не задана или пуста — используй `~/Projects` по умолчанию.

**Затем** вызови субагента `project-activity-digest` через `Task` tool. **ВАЖНО**: НЕ используй `run_in_background: true` — субагенту нужен доступ к инструментам, который недоступен в фоновом режиме. Передай папки с проектами прямо в промпте:

```
Task(
  subagent_type: "project-activity-digest",
  prompt: "Покажи активность в проектах за период с <WEEK_START> по <WEEK_END>. Папки с проектами: <ЗНАЧЕНИЕ_PROJECTS_DIRS>",
  description: "Project activity digest"
)
```

Результат субагента включи в итоговую сводку в секцию «Проекты».

---

## Формат вывода

```
## Обзор недели: DD.MM — DD.MM.YYYY

### Итого
- Задач создал: N
- Задач закрыл: N
- Встреч: N
- Трудозатраты: Xч Yмин
- Активных проектов: N, коммитов: N

### Встречи (по дням)

**Понедельник, DD.MM:**
| Время | Название | Место |
|-------|----------|-------|
| 10:00–11:00 | Планёрка команды | Контур.Толк (ссылка) |

*События на весь день:*
- Дедлайн проекта ABC

**Вторник, DD.MM:**
| Время | Название | Место |
|-------|----------|-------|
| 14:00–14:30 | Звонок с клиентом | Переговорная 3 |

(дни без встреч пропускай)

### Ключевые переписки

**Иванов Иван** — обсуждали сроки по проекту ABC
- Договорились: Иванов пришлёт макет до среды
- ⚠️ Ждёт ответа: «Какой формат отчёта нужен?»

**Проект ABC** (групповой) — координация спринта
- Решили: переносим релиз на пятницу

### Задачи

**Мне поставили:**
- #629000 «Подготовить отчёт» — от Осташева
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629000/

**Я создал:**
- #629010 «Проверить макет» — на Иванова
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629010/

**Закрыл:**
- #627050 «Сделать дашборд»
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/627050/

**Активные (топ-10 по последней активности):**
- #629501 «Поддержка после обновления Битрикс» — В работе, дедлайн 10.02
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629501/
- #534433 «Сделать инструмент для отслеживания индексаций» — Ждёт
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/534433/
(всего активных: N)

### Трудозатраты за неделю: Xч Yмин

| Задача | Время |
|--------|-------|
| #629501 «Поддержка после обновления Битрикс» | 5ч 00мин |
| #534433 «Инструмент для индексаций» | 2ч 30мин |

### Проекты (локальная разработка)
<вывод от project-activity-digest>
```

### Правила форматирования

- **Блок «Итого»** — первым, содержит ключевые цифры за неделю.
- **Встречи** группируются по дням — с заголовком дня недели и датой. Дни без встреч пропускай.
- **Время** встреч — в формате `HH:MM`, без секунд и таймзоны.
- События на весь день (`DT_SKIP_TIME=Y`) — отдельным списком под таблицей встреч соответствующего дня.
- **Активные задачи** — топ-10 по дате последней активности, показывай статус и дедлайн (если есть). Указывай общее число активных.
- **Трудозатраты** — таблица с задачами и залогированным временем за период. Время в формате `Xч Yмин`. Если трудозатрат нет — секцию не показывай.
- Пустые секции опускай (не пиши «Нет данных»).
- Числовые статусы задач преобразовывай: 2=Ждёт, 3=В работе, 4=На контроле, 5=Завершена, 6=Отложена.
- Если данных много — показывай топ-10 по каждой секции и указывай общее количество.
- **Ссылки на задачи**: после каждого упоминания задачи добавляй голый URL на следующей строке с отступом (2 пробела). Домен берётся из `BITRIX24_WEBHOOK_URL` (часть до `/rest/`). Формат: `https://<домен>/workgroups/group/0/tasks/task/view/<ID>/`.
- **Проекты**: вывод субагента `project-activity-digest` вставляй как есть, без переформатирования.
