---
name: weekly-review
description: "Обзор недели: сводка по задачам, встречам, перепискам из Битрикс24 и активности в локальных проектах. Активируется при упоминании: обзор недели, weekly review, итоги недели, сводка за неделю, что было за неделю, недельный отчёт"
---

# Weekly Review Skill

Skill для формирования сводки за неделю: задачи, встречи и переписки из Битрикс24 + активность в локальных проектах через субагента `project-activity-digest`.

**Read-only** — skill только читает данные.

## Авторизация

Вебхук хранится в файле `.env` в корне проекта в переменной `BITRIX24_WEBHOOK_URL`.

Каждый curl-запрос выполняй так:

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.name.json" ...
```

Если `.env` отсутствует или переменная не задана, сообщи пользователю:
> Создайте файл `.env` в корне проекта с содержимым:
> `export BITRIX24_WEBHOOK_URL="https://your-domain.bitrix24.ru/rest/USER_ID/WEBHOOK_CODE/"`

### ВАЖНО: не пайпить curl в python/jq в одной команде

**НИКОГДА** не делай `source .env && curl ... | python3 ...` — `source` может сломать пайп, и python получит пустой stdin.

Правильный подход — вызывать curl **отдельной командой** без пайпа. Если нужна постобработка — делай в два отдельных вызова Bash, либо сохраняй результат curl в переменную:

```bash
# НЕПРАВИЛЬНО (ломается):
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.json" | python3 -c "..."

# ПРАВИЛЬНО — curl без пайпа:
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.json"
```

## Определение периода

- По умолчанию — **текущая неделя**: от понедельника текущей недели до сегодня (включительно).
- «Прошлая неделя» — понедельник–воскресенье предыдущей недели.
- Пользователь может указать конкретные даты — адаптируй фильтры.

Для вычисления границ недели используй bash:
```bash
# Текущая неделя (пн–сегодня)
WEEK_START=$(date -v-Mon -v0H -v0M -v0S +%Y-%m-%d 2>/dev/null || date -d 'last monday' +%Y-%m-%d)
WEEK_END=$(date +%Y-%m-%d)

# Прошлая неделя (пн–вс)
WEEK_START=$(date -v-Mon -v-7d +%Y-%m-%d 2>/dev/null || date -d 'last monday - 7 days' +%Y-%m-%d)
WEEK_END=$(date -v-Mon -v-1d +%Y-%m-%d 2>/dev/null || date -d 'last sunday' +%Y-%m-%d)
```

## Алгоритм сбора данных

Используется Python-скрипт для максимальной скорости сбора данных через batch API Bitrix24 + субагент для суммаризации чатов.

### Шаг 1: Собрать данные Python-скриптом

Python-скрипт собирает: задачи, встречи, трудозатраты, git активность (всё кроме чатов).

**Для текущей недели:**
```bash
python3 .claude/scripts/weekly_review/main.py --week current
```

**Для прошлой недели:**
```bash
python3 .claude/scripts/weekly_review/main.py --week last
```

Скрипт автоматически:
- Использует batch API Bitrix24 для оптимизации (3-4 запроса вместо 30+)
- Собирает данные параллельно (задачи, встречи, трудозатраты, git)
- Форматирует вывод в markdown
- Обрабатывает ошибки gracefully

### Шаг 2: Получить суммаризацию чатов через субагент

Параллельно с запуском скрипта (или сразу после) вызови субагент `chat-digest`:

**Сначала** получи webhook URL и период:
```bash
source .env && echo "$BITRIX24_WEBHOOK_URL"
# И вычисли WEEK_START, WEEK_END (из Шага 0 выше)
```

**Затем** вызови субагент:
```
Task(
  subagent_type: "chat-digest",
  prompt: "Сформируй дайджест переписок Битрикс24.
    BITRIX24_WEBHOOK_URL: <URL из .env>
    USER_ID: <ID из профиля пользователя>
    USER_NAME: <Имя пользователя>
    Период: с <WEEK_START> по <WEEK_END>
    Лимит чатов: 200
    Топ диалогов: 10",
  description: "Chat digest for weekly review"
)
```

**ВАЖНО**: НЕ используй `run_in_background: true` — субагенту нужен доступ к инструментам.

### Шаг 3: Склеить результаты

1. Возьми вывод Python-скрипта (задачи, встречи, трудозатраты, git)
2. Вставь вывод субагента в секцию «Ключевые переписки»
3. Отформатируй финальный markdown отчёт

### Требования

**Перед первым использованием** установи зависимости:

```bash
cd .claude/scripts/weekly_review && pip3 install -r requirements.txt
```

**Необходимые переменные в .env:**
- `BITRIX24_WEBHOOK_URL` — URL вебхука Bitrix24 (обязательно)
- `PROJECTS_DIRS` (опционально) — папки с проектами, по умолчанию `~/projects`

---

## Формат вывода

```
## Обзор недели: DD.MM — DD.MM.YYYY

### Итого
- Задач создал: N
- Задач закрыл: N
- Встреч: N
- Трудозатраты: Xч Yмин
- Активных проектов: N, коммитов: N

### Встречи (по дням)

**Понедельник, DD.MM:**
| Время | Название | Место |
|-------|----------|-------|
| 10:00–11:00 | Планёрка команды | Контур.Толк (ссылка) |

*События на весь день:*
- Дедлайн проекта ABC

**Вторник, DD.MM:**
| Время | Название | Место |
|-------|----------|-------|
| 14:00–14:30 | Звонок с клиентом | Переговорная 3 |

(дни без встреч пропускай)

### Ключевые переписки

**Иванов Иван** — обсуждали сроки по проекту ABC
- Договорились: Иванов пришлёт макет до среды
- ⚠️ Ждёт ответа: «Какой формат отчёта нужен?»

**Проект ABC** (групповой) — координация спринта
- Решили: переносим релиз на пятницу

### Задачи

**Мне поставили:**
- #629000 «Подготовить отчёт» — от Осташева
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629000/

**Я создал:**
- #629010 «Проверить макет» — на Иванова
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629010/

**Закрыл:**
- #627050 «Сделать дашборд»
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/627050/

**Активные (топ-10 по последней активности):**
- #629501 «Поддержка после обновления Битрикс» — В работе, дедлайн 10.02
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629501/
- #534433 «Сделать инструмент для отслеживания индексаций» — Ждёт
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/534433/
(всего активных: N)

### Трудозатраты за неделю: Xч Yмин

| Задача | Время |
|--------|-------|
| #629501 «Поддержка после обновления Битрикс» | 5ч 00мин |
| #534433 «Инструмент для индексаций» | 2ч 30мин |

### Проекты (локальная разработка)
<вывод от project-activity-digest>
```

### Правила форматирования

- **Блок «Итого»** — первым, содержит ключевые цифры за неделю.
- **Встречи** группируются по дням — с заголовком дня недели и датой. Дни без встреч пропускай.
- **Время** встреч — в формате `HH:MM`, без секунд и таймзоны.
- События на весь день (`DT_SKIP_TIME=Y`) — отдельным списком под таблицей встреч соответствующего дня.
- **Активные задачи** — топ-10 по дате последней активности, показывай статус и дедлайн (если есть). Указывай общее число активных.
- **Трудозатраты** — таблица с задачами и залогированным временем за период. Время в формате `Xч Yмин`. Если трудозатрат нет — секцию не показывай.
- Пустые секции опускай (не пиши «Нет данных»).
- Числовые статусы задач преобразовывай: 2=Ждёт, 3=В работе, 4=На контроле, 5=Завершена, 6=Отложена.
- Если данных много — показывай топ-10 по каждой секции и указывай общее количество.
- **Ссылки на задачи**: после каждого упоминания задачи добавляй голый URL на следующей строке с отступом (2 пробела). Домен берётся из `BITRIX24_WEBHOOK_URL` (часть до `/rest/`). Формат: `https://<домен>/workgroups/group/0/tasks/task/view/<ID>/`.
- **Проекты**: вывод субагента `project-activity-digest` вставляй как есть, без переформатирования.
