---
name: daily-review
description: "Обзор дня: сводка по чатам, задачам, встречам из Битрикс24 и активности в локальных проектах. Активируется при упоминании: обзор дня, дайджест, сводка дня, что нового, что произошло за день, daily review"
---

# Daily Review Skill

Skill для формирования сводки рабочего дня из Битрикс24: непрочитанные чаты, активность по задачам, встречи из календаря.

**Read-only** — skill только читает данные.

## Авторизация

Вебхук хранится в файле `.env` в корне проекта в переменной `BITRIX24_WEBHOOK_URL`.

Каждый curl-запрос выполняй так:

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.name.json" ...
```

Если `.env` отсутствует или переменная не задана, сообщи пользователю:
> Создайте файл `.env` в корне проекта с содержимым:
> `export BITRIX24_WEBHOOK_URL="https://your-domain.bitrix24.ru/rest/USER_ID/WEBHOOK_CODE/"`

### ВАЖНО: не пайпить curl в python/jq в одной команде

**НИКОГДА** не делай `source .env && curl ... | python3 ...` — `source` может сломать пайп, и python получит пустой stdin.

Правильный подход — вызывать curl **отдельной командой** без пайпа. Если нужна постобработка — делай в два отдельных вызова Bash, либо сохраняй результат curl в переменную:

```bash
# НЕПРАВИЛЬНО (ломается):
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.json" | python3 -c "..."

# ПРАВИЛЬНО — curl без пайпа:
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.json"
```

## Определение периода

- По умолчанию — **сегодня** (текущая дата).
- Пользователь может попросить обзор за вчера, за неделю, за конкретную дату — адаптируй фильтры.
- Дата берётся из текущего контекста (сегодня задаётся системой).

## Алгоритм сбора данных

Все запросы можно выполнять **параллельно** — они независимы. Но сначала нужен ID текущего пользователя.

### Шаг 0: Получить профиль пользователя

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}profile.json"
```

Поле `result.ID` — ID пользователя. Поле `result.NAME` + `result.LAST_NAME` — имя для отображения.

### Шаг 1: Дайджест переписок

Цель — не просто показать непрочитанное, а дать **выжимку из переписок за день**: о чём договорились, какие решения приняли, что обсуждали.

#### 1а. Получить список активных диалогов

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}im.recent.list.json" \
  -d 'SKIP_OPENLINES=Y'
```

**ВАЖНО**: `date_last_activity` показывает дату самой последней активности, а не историческую. Если чат был активен в запрашиваемый период, но также имел активность позже — `date_last_activity` будет показывать более позднюю дату. Поэтому **НЕ фильтруй чаты по `date_last_activity`** попадающей строго в целевой период.

Вместо этого:
1. Возьми все чаты из `result.items`
2. Исключи служебные: где `title` содержит «Уведомления», «Notifications», или `type` = `notification`
3. Исключи чаты, где `date_last_activity` **раньше** начала запрашиваемого периода (в них точно нет сообщений за этот день)
4. Из оставшихся бери **до 20 чатов** (приоритет: личные `user` > групповые `chat`)

Ключевые поля:
- `id` — DIALOG_ID (число для личных, `chatXXX` для групповых)
- `title` — имя собеседника или название чата
- `date_last_activity` — дата последней активности
- `counter` — непрочитанные (полезно для пометки)
- `type` — `user` (личный) или `chat` (групповой)

#### 1б. Загрузить сообщения и проверить наличие за период

Для каждого отобранного диалога загрузи сообщения:

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}im.dialog.messages.get.json" \
  -d 'DIALOG_ID=<ID>' \
  -d 'LIMIT=20'
```

- Лимит **20 сообщений** за запрос (ограничение API).
- Из загруженных сообщений отфильтруй те, где `date` попадает в запрашиваемый период.
- **Если на первой странице нет сообщений за период** — пагинируй через `LAST_ID` (ID самого старого сообщения из ответа), чтобы добраться до нужного периода. Максимум **3 страницы** пагинации.
- **Если на первой странице все сообщения попадают в период** — загрузи ещё страницы (до 5 страниц = 100 сообщений максимум на диалог).
- Если после пагинации сообщений за период не найдено — пропускай диалог.
- Используй массив `users` из ответа для преобразования `author_id` в имена.

**Отбор для выжимки**: из диалогов, в которых нашлись сообщения за период, выбери **топ-15** по количеству сообщений. Приоритет: сначала личные (`user`), потом групповые (`chat`).

#### 1в. Анализ и выжимка

Для каждого диалога с сообщениями за период сформируй краткую выжимку:

1. **Тема/контекст** — о чём шла переписка (1 предложение)
2. **Договорённости и решения** — если кто-то пообещал что-то сделать, согласовал сроки, подтвердил задачу — выдели это отдельно. Маркеры: «сделаю», «договорились», «ок, до пятницы», «принято», «давай так», «возьму на себя», «жди до...», «готово, проверь»
3. **Требует реакции** — если последнее сообщение содержит вопрос или просьбу, адресованную пользователю, пометь это

**Не включай** в выжимку:
- Чисто бытовые диалоги без рабочего содержания (приветствия, мемы, реакции)
- Системные уведомления
- Диалоги, в которых за день было менее 2 сообщений от разных авторов (монологи)

### Шаг 2: Активность по задачам

Используй формат дат `YYYY-MM-DD` и `--data-urlencode` для фильтров с операторами.

Для фильтрации по конкретному дню (например, 3 февраля 2026):
- `filter[>FIELD]=2026-02-02` (день до)
- `filter[<FIELD]=2026-02-04` (день после)

#### 2а. Задачи, которые я создал за период

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[CREATED_BY]=<USER_ID>' \
  --data-urlencode 'filter[>CREATED_DATE]=<ДЕНЬ_ДО>' \
  --data-urlencode 'filter[<CREATED_DATE]=<ДЕНЬ_ПОСЛЕ>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=STATUS' \
  -d 'select[]=CREATED_DATE' -d 'select[]=RESPONSIBLE_ID'
```

#### 2б. Задачи, которые мне поставили за период

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[RESPONSIBLE_ID]=<USER_ID>' \
  --data-urlencode 'filter[>CREATED_DATE]=<ДЕНЬ_ДО>' \
  --data-urlencode 'filter[<CREATED_DATE]=<ДЕНЬ_ПОСЛЕ>' \
  --data-urlencode 'filter[!CREATED_BY]=<USER_ID>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=STATUS' \
  -d 'select[]=CREATED_DATE' -d 'select[]=CREATED_BY'
```

#### 2в. Задачи, закрытые за период

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[RESPONSIBLE_ID]=<USER_ID>' \
  -d 'filter[STATUS]=5' \
  --data-urlencode 'filter[>CLOSED_DATE]=<ДЕНЬ_ДО>' \
  --data-urlencode 'filter[<CLOSED_DATE]=<ДЕНЬ_ПОСЛЕ>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=CLOSED_DATE'
```

#### 2г. Задачи с горящим дедлайном

Задачи, где дедлайн попадает в запрашиваемый период (сегодня или ближайшие дни):

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[RESPONSIBLE_ID]=<USER_ID>' \
  --data-urlencode 'filter[!STATUS]=5' \
  --data-urlencode 'filter[>DEADLINE]=<ДЕНЬ_ДО>' \
  --data-urlencode 'filter[<DEADLINE]=<ДЕНЬ_ПОСЛЕ>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=DEADLINE' -d 'select[]=STATUS'
```

#### 2д. Новые комментарии (опционально)

Если результатов по шагам 2а–2г мало, дополнительно проверь комментарии в активных задачах. Стратегия:

1. Получи до 20 активных задач пользователя:
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.list.json" \
  -d 'filter[RESPONSIBLE_ID]=<USER_ID>' \
  --data-urlencode 'filter[!STATUS]=5' \
  -d 'order[ID]=desc' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'start=0'
```

2. Для каждой задачи запроси последние комментарии:
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}task.commentitem.getlist.json" \
  -d 'TASKID=<ID>' -d 'ORDER[ID]=desc'
```

3. Фильтруй: оставь только комментарии за период, где `AUTHOR_ID` ≠ `"0"` (не системные) и `AUTHOR_ID` ≠ `<USER_ID>` (не свои).

### Шаг 3: Встречи из календаря

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}calendar.event.get.json" \
  -H "Content-Type: application/json" \
  -d '{"type":"user","ownerId":<USER_ID>,"from":"<ДАТА_ОТ>","to":"<ДАТА_ДО>"}'
```

Где `<ДАТА_ОТ>` и `<ДАТА_ДО>` — границы запрашиваемого периода в формате `YYYY-MM-DD`.

Ключевые поля ответа:
- `ID` — ID события
- `NAME` — название встречи
- `DATE_FROM` / `DATE_TO` — начало и конец
- `DESCRIPTION` — описание
- `LOCATION` — место/ссылка на звонок
- `IS_MEETING` — есть ли участники
- `MEETING_STATUS` — статус участия: `Y` (принял), `N` (отклонил), `Q` (не ответил)
- `DT_SKIP_TIME` — `Y` если событие на весь день

**Фильтрация**: показывай только события со статусом `Y` или `Q` (принятые или без ответа). События с `N` — пропускай.

### Шаг 4: Активность в локальных проектах

Вызови субагента `project-activity-digest` через `Task` tool:

```
Task(
  subagent_type: "project-activity-digest",
  prompt: "Покажи активность в проектах за период с <ДАТА_ОТ> по <ДАТА_ДО>",
  description: "Project activity digest"
)
```

Где `<ДАТА_ОТ>` и `<ДАТА_ДО>` — границы запрашиваемого дня (например, `2026-02-04` и `2026-02-04`).

Результат субагента включи в итоговую сводку в секцию «Проекты». Если за день коммитов не было — секцию не показывай.

---

## Формат вывода

Выводи результат в виде структурированной сводки. Адаптируй секции под наличие данных — пустые секции не показывай.

```
## Обзор дня: <дата>

### Встречи
| Время | Название | Место |
|-------|----------|-------|
| 10:00–11:00 | Планёрка команды | Контур.Толк (ссылка) |
| 14:00–14:30 | Звонок с клиентом | Переговорная 3 |

*Событий на весь день:*
- Дедлайн проекта ABC

### Переписки

**Иванов Иван** — обсуждали сроки по проекту ABC
- Договорились: Иванов пришлёт макет до среды, я проверю в тот же день
- ⚠️ Ждёт ответа: «Какой формат отчёта нужен?»

**Проект ABC** (групповой) — координация спринта
- Решили: переносим релиз на пятницу
- Осташева берёт на себя тестирование

**Петрова Мария** — вопрос по доступам
- Я пообещал настроить доступ к дашборду до конца дня

### Задачи

**Горящие дедлайны (сегодня):**
- #628902 «Подготовить презентацию» — дедлайн 18:00
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/628902/

**Мне поставили:**
- #629000 «Подготовить отчёт» — от Осташева
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629000/

**Я создал:**
- #629010 «Проверить макет» — на Иванова
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629010/

**Закрыл:**
- #627050 «Сделать дашборд»
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/627050/

**Новые комментарии:**
- #626879 «Файл рентабельности» — Осташева: «Проверь формулу в колонке D»
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/626879/

### Проекты (локальная разработка)
<вывод от project-activity-digest>
```

### Правила форматирования

- **Встречи** идут первыми — это самое срочное (можно опоздать).
- **Время** встреч — в формате `HH:MM`, без секунд и таймзоны.
- События на весь день (`DT_SKIP_TIME=Y`) — отдельным списком под таблицей встреч.
- **Горящие дедлайны** — перед остальными задачами, выделяются как важные.
- Пустые секции опускай (не пиши «Нет данных»).
- Числовые статусы задач преобразовывай: 2=Ждёт, 3=В работе, 4=На контроле, 5=Завершена, 6=Отложена.
- Если данных много — показывай топ-10 по каждой секции и указывай общее количество.
- **Ссылки на задачи**: после каждого упоминания задачи добавляй голый URL на следующей строке с отступом (2 пробела). Домен берётся из `BITRIX24_WEBHOOK_URL` (часть до `/rest/`). Формат: `https://<домен>/workgroups/group/0/tasks/task/view/<ID>/`. Голый URL кликабелен в Terminal.app.
- **Проекты**: вывод субагента `project-activity-digest` вставляй как есть, без переформатирования. Если за день коммитов не было — секцию не показывай.
