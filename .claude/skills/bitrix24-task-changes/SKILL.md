---
name: bitrix24-task-changes
description: "Изменения задач Битрикс24: дедлайн, комментарий, трудозатраты, название, описание, история изменений. Активируется при: изменить задачу, поменять дедлайн, добавить комментарий в задачу, списать время, трудозатраты, написать в задачу, история задачи, что менялось в задаче, лог изменений"
---

# Bitrix24 Task Changes Skill

Скилл для модификации задач Битрикс24: дедлайн, комментарии (чат), трудозатраты, название и описание.

## Авторизация

Вебхук хранится в файле `.env` в корне проекта в переменной `BITRIX24_WEBHOOK_URL`.

Каждый curl-запрос выполняй так:

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.name.json" ...
```

Если `.env` отсутствует или переменная не задана, сообщи пользователю:
> Создайте файл `.env` в корне проекта с содержимым:
> `export BITRIX24_WEBHOOK_URL="https://your-domain.bitrix24.ru/rest/USER_ID/WEBHOOK_CODE/"`

### ВАЖНО: не пайпить curl в python/jq в одной команде

**НИКОГДА** не делай `source .env && curl ... | python3 ...` — `source` может сломать пайп, и python получит пустой stdin.

Правильный подход — вызывать curl **отдельной командой** без пайпа. Если нужна постобработка — делай в два отдельных вызова Bash, либо сохраняй результат curl в переменную:

```bash
# НЕПРАВИЛЬНО (ломается):
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.json" | python3 -c "..."

# ПРАВИЛЬНО — curl без пайпа:
source .env && curl -s "${BITRIX24_WEBHOOK_URL}method.json"
```

## Логика работы

1. Пользователь говорит: «поменяй дедлайн задачи 629000 на пятницу» или «добавь 2 часа в задачу 629000» или «напиши в задачу 629000: проверил, всё ок»
2. Парсишь запрос: определяешь ID задачи и тип операции
3. Для операций **с подтверждением** (название, описание) — сначала `tasks.task.get`, показ текущего значения, `AskUserQuestion`
4. Для операций **без подтверждения** (дедлайн, комментарий, трудозатраты) — выполнение сразу
5. После выполнения — краткий отчёт с результатом и ссылкой на задачу

## Правила подтверждений

| Операция | Подтверждение |
|----------|---------------|
| Изменить дедлайн | Нет |
| Отправить комментарий (чат) | Нет |
| Добавить трудозатраты | Нет |
| Изменить название | **Да** — через `AskUserQuestion` |
| Изменить описание | **Да** — через `AskUserQuestion` |
| Посмотреть историю изменений | Нет |

---

## Операция 1: Изменить дедлайн

**Без подтверждения.**

### Шаги

1. Получи текущие данные задачи (для отображения старого дедлайна и названия):
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.get.json" \
  -d 'taskId=<ID>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=DEADLINE'
```

2. Обнови дедлайн:
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.update.json" \
  -d 'taskId=<ID>' \
  --data-urlencode 'fields[DEADLINE]=<YYYY-MM-DDTHH:MM:SS+03:00>'
```

### Формат даты

- Всегда используй формат `YYYY-MM-DDTHH:MM:SS+03:00`
- Если пользователь говорит «пятница» или «завтра» — вычисли конкретную дату
- Если время не указано — ставь `18:00:00` (конец рабочего дня)
- **Важно**: передавай через `--data-urlencode` из-за символа `+` в таймзоне

### Формат вывода

```
Задача #629000 «Подготовить отчёт»:
- Дедлайн изменён: 05.02.2026 → 07.02.2026
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629000/
```

---

## Операция 2: Отправить комментарий (чат задачи)

**Без подтверждения.**

### Стратегия: новый метод с фоллбеком на legacy

Сначала пробуй новый метод `tasks.task.chat.message.send`. Если он вернул `ERROR_METHOD_NOT_FOUND` — используй legacy-метод `task.commentitem.add`.

### Шаблон (новый метод — предпочтительный)

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.chat.message.send.json" \
  -d 'taskId=<ID>' \
  --data-urlencode 'message=<ТЕКСТ СООБЩЕНИЯ>'
```

### Шаблон (legacy — фоллбек)

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}task.commentitem.add.json" \
  -d 'TASKID=<ID>' \
  --data-urlencode 'FIELDS[POST_MESSAGE]=<ТЕКСТ СООБЩЕНИЯ>'
```

**Ответ legacy**: `{"result": "<ID комментария>"}`.

### Важно

- Текст сообщения передавай через `--data-urlencode` — он может содержать спецсимволы
- Если новый метод вернул ошибку `ERROR_METHOD_NOT_FOUND` — молча переключайся на legacy, не спрашивая пользователя

### Шаги

1. Попробуй отправить через `tasks.task.chat.message.send`
2. Если `ERROR_METHOD_NOT_FOUND` — отправь через `task.commentitem.add`
3. Если нужно название задачи для вывода — предварительно получи через `tasks.task.get`

### Формат вывода

```
Задача #629000 «Подготовить отчёт»:
- Сообщение отправлено в чат задачи
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629000/
```

---

## Операция 3: Добавить трудозатраты

**Без подтверждения.**

### API: task.elapseditem.add

**URL**: `${BITRIX24_WEBHOOK_URL}task.elapseditem.add.json`

**Параметры**:
- `TASKID` — **обязательный**, ID задачи
- `ARFIELDS[SECONDS]` — **обязательный**, время в секундах
- `ARFIELDS[COMMENT_TEXT]` — комментарий к трудозатратам (опциональный)
- `ARFIELDS[CREATED_DATE]` — дата трудозатрат (опциональный, формат `YYYY-MM-DDTHH:MM:SS+03:00`)

### Конвертация времени

Пользователь может указать время в любом формате. Конвертируй в секунды:

| Ввод пользователя | Секунды |
|--------------------|---------|
| 1ч30м, 1ч 30мин, 1h30m | 5400 |
| 2ч, 2h, 2 часа | 7200 |
| 30м, 30мин, 30 минут | 1800 |
| 90 минут | 5400 |
| 1.5ч, 1,5 часа | 5400 |

### Шаблон

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}task.elapseditem.add.json" \
  -d 'TASKID=<ID>' \
  -d 'ARFIELDS[SECONDS]=<СЕКУНДЫ>' \
  --data-urlencode 'ARFIELDS[COMMENT_TEXT]=<КОММЕНТАРИЙ>'
```

С указанием даты:
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}task.elapseditem.add.json" \
  -d 'TASKID=<ID>' \
  -d 'ARFIELDS[SECONDS]=<СЕКУНДЫ>' \
  --data-urlencode 'ARFIELDS[COMMENT_TEXT]=<КОММЕНТАРИЙ>' \
  --data-urlencode 'ARFIELDS[CREATED_DATE]=<YYYY-MM-DDTHH:MM:SS+03:00>'
```

**Ответ**:
```json
{
  "result": 123
}
```
Где `result` — ID записи трудозатрат.

### Формат вывода

Покажи время в человекочитаемом формате:

```
Задача #629000 «Подготовить отчёт»:
- Трудозатраты добавлены: 2ч 30мин
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629000/
```

---

## Операция 4: Изменить название

**С ПОДТВЕРЖДЕНИЕМ через `AskUserQuestion`.**

### Шаги

1. Получи текущие данные задачи:
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.get.json" \
  -d 'taskId=<ID>' \
  -d 'select[]=ID' -d 'select[]=TITLE'
```

2. Покажи пользователю текущее название и запроси подтверждение через `AskUserQuestion`:
   - Вопрос: «Изменить название задачи #<ID>?»
   - Показать: текущее → новое
   - Варианты: «Да, изменить» / «Нет, отменить»

3. При подтверждении — обнови:
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.update.json" \
  -d 'taskId=<ID>' \
  --data-urlencode 'fields[TITLE]=<НОВОЕ НАЗВАНИЕ>'
```

### Формат вывода

```
Задача #629000:
- Название изменено: «Подготовить отчёт» → «Подготовить квартальный отчёт»
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629000/
```

---

## Операция 5: Изменить описание

**С ПОДТВЕРЖДЕНИЕМ через `AskUserQuestion`.**

### Шаги

1. Получи текущие данные задачи:
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.get.json" \
  -d 'taskId=<ID>' \
  -d 'select[]=ID' -d 'select[]=TITLE' -d 'select[]=DESCRIPTION'
```

2. Покажи пользователю текущее описание (или первые 200 символов, если длинное) и запроси подтверждение через `AskUserQuestion`:
   - Вопрос: «Изменить описание задачи #<ID> «<НАЗВАНИЕ>»?»
   - Показать: текущее описание (начало) и новое описание
   - Варианты: «Да, изменить» / «Нет, отменить»

3. При подтверждении — обнови:
```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}tasks.task.update.json" \
  -d 'taskId=<ID>' \
  --data-urlencode 'fields[DESCRIPTION]=<НОВОЕ ОПИСАНИЕ>'
```

### Формат вывода

```
Задача #629000 «Подготовить отчёт»:
- Описание обновлено
  https://team.up-advert.ru/workgroups/group/0/tasks/task/view/629000/
```

---

## Операция 6: Посмотреть историю изменений

**Без подтверждения. Только по запросу пользователя. Не включать в обзоры (daily-review, weekly-review).**

### API: task.logitem.list

**URL**: `${BITRIX24_WEBHOOK_URL}task.logitem.list.json`

**Параметры**:
- `TASKID` — **обязательный**, ID задачи
- `ORDER[CREATED_DATE]` — сортировка (`asc` / `desc`)

### Шаблон

```bash
source .env && curl -s "${BITRIX24_WEBHOOK_URL}task.logitem.list.json" \
  -d 'TASKID=<ID>' \
  -d 'ORDER[CREATED_DATE]=desc'
```

### Структура записи

```json
{
  "CREATED_DATE": "2026-01-27T12:23:45+05:00",
  "USER_ID": 1535,
  "TASK_ID": 626663,
  "FIELD": "DEADLINE",
  "FROM_VALUE": "1769778000",
  "TO_VALUE": "1770037200"
}
```

### Типы полей (FIELD)

| FIELD | Значение | Как отображать |
|-------|----------|----------------|
| `NEW` | Задача создана | «Создана» |
| `DEADLINE` | Изменён дедлайн | FROM_VALUE/TO_VALUE — unix timestamp, конвертировать в дату |
| `STATUS` | Изменён статус | Числовой ID → текстовое название (2-6) |
| `STAGE` | Изменён этап (канбан) | FROM_VALUE/TO_VALUE — названия этапов |
| `COMMENT` | Добавлен комментарий | TO_VALUE — ID комментария |
| `DESCRIPTION` | Изменено описание | FROM_VALUE/TO_VALUE могут быть пустыми |
| `TITLE` | Изменено название | FROM_VALUE → TO_VALUE |
| `RESPONSIBLE_ID` | Сменён ответственный | ID пользователей |
| `TIME_SPENT_IN_LOGS` | Трудозатраты | Значения в секундах |

### Формат вывода

```
История задачи #626663 «Объединить проекты»:

30.01 — Комментарий (Степанов С.)
29.01 — Комментарий (Степанов С.)
27.01 — Этап: Запланированы → В спринте (Степанов С.)
20.01 — Дедлайн установлен: 30.01.2026 (Степанов С.)
20.01 — Описание изменено (Степанов С.)
20.01 — Задача создана (Степанов С.)
```

Если USER_ID известен (например, текущий пользователь) — показывай имя. Иначе — ID.

---

## Ссылки на задачи

Домен берётся из `BITRIX24_WEBHOOK_URL` (часть до `/rest/`). Формат ссылки:

```
https://<домен>/workgroups/group/0/tasks/task/view/<ID>/
```

Ссылку выводи голым URL на отдельной строке с отступом 2 пробела — так она кликабельна в Terminal.app.
