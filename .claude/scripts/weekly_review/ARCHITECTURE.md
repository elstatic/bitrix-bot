# Архитектура Weekly Review

## Разделение ответственности

### Python-скрипт (main.py)
**Ответственность:** Быстрый сбор структурированных данных из Bitrix24 и git

**Собирает:**
- ✅ Задачи (через batch API)
- ✅ Встречи (calendar API)
- ✅ Трудозатраты (через batch API)
- ✅ Git активность (локальные проекты)

**Не собирает:**
- ❌ Чаты (делает субагент)

**Преимущества:**
- Использует batch API → 2-3 запроса вместо 30+
- Параллельный сбор через asyncio
- Быстрое выполнение (5-15 сек)
- Graceful degradation

### Субагент chat-digest
**Ответственность:** Суммаризация переписок Bitrix24 через Claude

**Делает:**
- Загружает чаты (im.recent.list + im.dialog.messages.get)
- Суммаризует через Claude (доступ через Task tool)
- Извлекает договорённости, решения, вопросы
- Определяет, требуется ли реакция

**Преимущества:**
- Использует OAuth авторизацию Claude Code
- Не требует API ключей от пользователя
- Качественная суммаризация через Claude Sonnet

### Skill weekly-review
**Ответственность:** Оркестрация и склейка результатов

**Делает:**
1. Определяет период (текущая/прошлая неделя)
2. Запускает Python-скрипт → получает данные о задачах, встречах, git
3. Запускает субагент chat-digest → получает суммаризацию чатов
4. Склеивает результаты в единый markdown отчёт
5. Форматирует и выводит пользователю

## Поток данных

```
User: /weekly-review
    ↓
Skill: weekly-review/SKILL.md
    ↓
    ├─→ Python script (main.py)
    │   ├─→ Bitrix24 API (batch)
    │   │   ├─ Задачи
    │   │   ├─ Встречи
    │   │   └─ Трудозатраты
    │   └─→ Git (subprocess)
    │       └─ Коммиты, статистика
    │
    └─→ Субагент (chat-digest)
        ├─→ Bitrix24 API (im.*)
        │   └─ Чаты, сообщения
        └─→ Claude API (Task tool)
            └─ Суммаризация
    ↓
Skill склеивает результаты
    ↓
User получает markdown отчёт
```

## Оптимизации

### Batch API (Python)
- **Задачи**: 4 запроса → 1 batch
- **Трудозатраты**: N запросов → 1 batch
- **Итого**: 2-3 HTTP запроса вместо 10-20

### Async (Python)
- Параллельный сбор всех секций
- Параллельные git операции для проектов

### Субагент (chat-digest)
- Пагинация чатов (до 5 страниц)
- Параллельная суммаризация через asyncio
- Кеширование не требуется (быстро)

### Кеширование (Python)
- Список проектов: 24 часа TTL
- Путь: `~/.cache/weekly-review/projects-cache.json`

## Требования

### Системные
- Python 3.8+
- pip3

### Python-зависимости
- aiohttp (HTTP клиент)
- python-dotenv (загрузка .env)

### Переменные окружения
- `BITRIX24_WEBHOOK_URL` (обязательно)
- `PROJECTS_DIRS` (опционально, по умолчанию `~/projects`)

### Авторизация
- Bitrix24: через webhook (из .env)
- Claude: через OAuth (встроено в Claude Code)

## Сравнение с оригинальным подходом

| Аспект | Было (bash + curl) | Стало (Python + субагент) |
|--------|-------------------|--------------------------|
| HTTP запросы | 30+ последовательно | 2-3 batch параллельно |
| Суммаризация | Субагент (медленно) | Субагент (быстрее, только чаты) |
| Git анализ | Субагент | Python (async) |
| Время выполнения | 30-60 сек | 5-15 сек |
| Ускорение | — | **3-6x** |
| API ключи | Требовались | **Не требуются** |

## Расширяемость

### Добавление новых источников данных
1. Создать новый анализатор в `analyzers/`
2. Добавить вызов в `WeeklyReviewCollector.collect_all()`
3. Обновить модели в `models.py`
4. Обновить форматтер в `formatters/markdown.py`

### Добавление новых форматов вывода
1. Создать новый форматтер в `formatters/`
2. Использовать те же модели данных (`WeeklyReportData`)
3. Добавить CLI флаг для выбора формата

### Интеграция с другими системами
- Jira: добавить `JiraClient` + `JiraTaskAnalyzer`
- GitHub: добавить `GitHubAnalyzer` для PR/Issues
- Slack: аналогично chat-digest для Slack
